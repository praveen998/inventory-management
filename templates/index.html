<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Author - GraphQL</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <h1>Create Author</h1>
    <!-- Create Author Section -->
    <form id="create-author-form">
        <label>
            Name:
            <input type="text" id="author-name" name="name" required>
        </label><br>
        <label>
            Birth Date:
            <input type="date" id="author-birth-date" name="birthDate" required>
        </label><br>
        <button type="submit">Create Author</button>
    </form>

    <p id="create-author-status"></p>
    <h1>Fetch Authors</h1>
    <!-- Fetch Authors Button -->
    <button id="fetch-authors">Fetch All Authors</button>
    <!-- Authors List -->
    <ul id="authors-list"></ul>

    <h1>Update Author</h1>
    <form id="update-author-form">
        <label for="author-id">Author ID:</label><br>
        <input type="number" id="updateauthor-id" name="author-id" required><br><br>

        <label for="author-name">Author Name:</label><br>
        <input type="text" id="updateauthor-name" name="author-name"><br><br>

        <label for="author-birthdate">Birth Date:</label><br>
        <input type="date" id="updateauthor-birthdate" name="author-birthdate"><br><br>

        <button type="submit">Update Author</button>
    </form>


    <div id="response-message" style="margin-top: 20px; color: green;"></div>
    <!-- Fetch Authors Button -->

    <script>
        const graphqlEndpoint = "http://127.0.0.1:8000/graphql/";

        $("#update-author-form").on("submit", function (event) {
                event.preventDefault();
                const authorId = $("#updateauthor-id").val();
                const authorName = $("#updateauthor-name").val();
                const authorBirthDate = $("#updateauthor-birthdate").val();
                const graphqlQuery = {
                    query: `
                        mutation {
                            updateAuthor(id: ${authorId}, name: "${authorName}", birthDate: "${authorBirthDate}") {
                                author {
                                    id
                                    name
                                    birthDate
                                }
                            }
                        }
                    `
                };


                $.ajax({
                    url: graphqlEndpoint,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(graphqlQuery),
                    success: function (response) {
                        const updatedAuthor = response.data.updateAuthor.author;
                        if (updatedAuthor) {
                            
                            $("#response-message").html(
                                `Author updated successfully: ID=${updatedAuthor.id}, Name=${updatedAuthor.name}, Birth Date=${updatedAuthor.birthDate}`
                            );

                        } else {
                            $("#response-message").html("Failed to update author.").css("color", "red");
                        }
                    },
                    error: function (xhr, status, error) {
                        $("#response-message").html("Error: " + error).css("color", "red");
                    }
                });
            });


        // Create a new author
        $("#create-author-form").on("submit", function (e) {
            e.preventDefault(); // Prevent default form submission
            const name = $("#author-name").val();
            const birthDate = $("#author-birth-date").val();
            const mutation = `
                mutation CreateAuthor($name: String!, $birthDate: Date!) {
                    createAuthor(name: $name, birthDate: $birthDate) {
                        author {
                            id
                            name
                            birthDate
                        }
                    }
                }
            `;

            $.ajax({
                url: graphqlEndpoint,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    query: mutation,
                    variables: { name: name, birthDate: birthDate },
                }),
                success: function (response) {
                    const author = response.data.createAuthor.author;
                    $("#create-author-status").text(`Author "${author.name}" created successfully!`);
                    $("#create-author-form")[0].reset(); // Reset form fields
                },
                error: function (error) {
                    console.error("Error creating author:", error);
                    $("#create-author-status").text("Error creating author.");
                }
            });
        });


        $("#fetch-authors").on("click", function () {
          const query = `
                query {
                    allAuthors {
                        id
                        name
                        birthDate
                        books {
                            id
                            title
                            publishedDate
                        }
                    }
                }
            `;

            $.ajax({
                url: graphqlEndpoint,
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ query: query }),
                success: function (response) {
                    const authors = response.data.allAuthors;
                    const authorsList = $("#authors-list");
                    authorsList.empty(); // Clear the list
                    authors.forEach(author => {
                        const books = author.books.map(book => `${book.title} (Published: ${book.publishedDate})`).join(", ");
                        authorsList.append(`<li>${author.name} (Born: ${author.birthDate})<br>Books: ${books || "No books"}</li>`);
                    });
                },

                error: function (error) {
                    console.error("Error fetching authors:", error);
                }
            });
        });

    </script>
</body>
</html>
